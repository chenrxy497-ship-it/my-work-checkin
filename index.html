<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ‰“å¡ v4</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 360px; text-align: center; }
        
        h1 { margin: 10px 0; color: #333; font-size: 1.6em; }
        .time-display { font-size: 2.8em; font-weight: 800; color: #2c3e50; margin: 10px 0; font-variant-numeric: tabular-nums; }
        .status-text { margin-bottom: 20px; font-weight: bold; color: #666; background: #eee; padding: 5px 15px; border-radius: 20px; display: inline-block; }
        
        /* 4 é¡†æŒ‰éˆ•æ¨£å¼ */
        button { width: 100%; padding: 15px; margin: 6px 0; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.1s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.97); }
        
        .btn-start { background: linear-gradient(135deg, #34C759, #30B753); color: white; }
        .btn-counsel-start { background: linear-gradient(135deg, #FF9500, #F58F00); color: white; }
        .btn-counsel-end { background: linear-gradient(135deg, #007AFF, #006EE6); color: white; } /* è—è‰²æŒ‰éˆ• */
        .btn-end { background: linear-gradient(135deg, #FF3B30, #E6352B); color: white; }
        
        /* åœç”¨ç‹€æ…‹ */
        .btn-disabled { background: #E5E5EA; color: #C7C7CC; box-shadow: none; cursor: not-allowed; pointer-events: none; }

        /* å·¥ä½œæ—¥èªŒå€ (Memo + èªéŸ³) */
        .memo-area { margin-top: 15px; display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #007AFF; }
        
        .btn-mic { width: 50px; background: #eee; color: #333; font-size: 20px; display: flex; align-items: center; justify-content: center; padding: 0; box-shadow: none; }
        .btn-mic.listening { background: #FF3B30; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #loading { display: none; margin-top: 10px; color: #007AFF; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ’¼ è£œç¿’ç­æ‰“å¡</h1>
        <div id="current-time" class="time-display">00:00:00</div>
        <div id="status" class="status-text">ç‹€æ…‹ï¼šå°šæœªä¸Šç­</div>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

        <button id="btn-start" class="btn-start" onclick="sendData('start_work')">ğŸŸ¢ ä¸Šç­ (è¡Œæ”¿é–‹å§‹)</button>
        <button id="btn-c-start" class="btn-counsel-start btn-disabled" onclick="sendData('start_counseling')">ğŸŸ  é–‹å§‹è¼”å°</button>
        <button id="btn-c-end" class="btn-counsel-end btn-disabled" onclick="sendData('end_counseling')">ğŸ”µ è¼”å°çµæŸ (è½‰è¡Œæ”¿)</button>
        <button id="btn-end" class="btn-end btn-disabled" onclick="sendData('end_work')">ğŸ ä¸‹ç­ / çµæŸ</button>

        <div class="memo-area">
            <input type="text" id="memo-input" placeholder="å·¥ä½œæ—¥èªŒ (é¸å¡«)...">
            <button class="btn-mic" onclick="startDictation()">ğŸ™ï¸</button>
        </div>

        <p id="loading">â³ è³‡æ–™è™•ç†ä¸­...</p>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹å¡«å…¥æ–°çš„ Apps Script ç¶²å€ â˜…â˜…â˜…
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIMXeCyjB9vFQdT162g-o2blrf3T9fciXM_qcEABzw-oeb5o8wY0CekTpMh8Zm33sOKQ/exec";

        setInterval(() => {
            document.getElementById('current-time').innerText = new Date().toLocaleTimeString('en-GB', {hour12: false});
        }, 1000);

        // ç‹€æ…‹ç®¡ç†
        let currentState = localStorage.getItem('workState_v4') || 'idle'; 
        updateUI(currentState);

        function updateUI(state) {
            const bStart = document.getElementById('btn-start');
            const bCStart = document.getElementById('btn-c-start');
            const bCEnd = document.getElementById('btn-c-end');
            const bEnd = document.getElementById('btn-end');
            const sText = document.getElementById('status');

            // å…ˆå…¨éƒ¨å•Ÿç”¨ï¼Œä¸‹é¢å†æ ¹æ“šé‚è¼¯é–ä½
            bStart.className = 'btn-start'; bCStart.className = 'btn-counsel-start'; 
            bCEnd.className = 'btn-counsel-end'; bEnd.className = 'btn-end';
            bStart.disabled = false; bCStart.disabled = false; bCEnd.disabled = false; bEnd.disabled = false;
            
            // é‡ç½®é–å®š
            bStart.classList.remove('btn-disabled'); bCStart.classList.remove('btn-disabled');
            bCEnd.classList.remove('btn-disabled'); bEnd.classList.remove('btn-disabled');

            if (state === 'idle') {
                // æ²’ä¸Šç­ï¼šåªèƒ½æŒ‰ä¸Šç­
                disable(bCStart, bCEnd, bEnd);
                sText.innerText = "ç‹€æ…‹ï¼šå°šæœªä¸Šç­"; sText.style.color = "#666";
            } 
            else if (state === 'working_admin') {
                // è¡Œæ”¿ä¸­ï¼šå¯ä»¥æŒ‰ã€Œè¼”å°é–‹å§‹ã€æˆ–ã€Œä¸‹ç­ã€ï¼Œä¸èƒ½æŒ‰ã€Œä¸Šç­ã€æˆ–ã€Œè¼”å°çµæŸã€
                disable(bStart, bCEnd);
                sText.innerText = "ğŸŸ¢ è¡Œæ”¿å·¥ä½œä¸­..."; sText.style.color = "#34C759";
            } 
            else if (state === 'working_counsel') {
                // è¼”å°ä¸­ï¼šåªèƒ½æŒ‰ã€Œè¼”å°çµæŸã€ï¼Œå…¶ä»–éƒ½ä¸è¡Œ (å¼·è¿«å…ˆçµæŸè¼”å°æ‰èƒ½ä¸‹ç­)
                disable(bStart, bCStart, bEnd);
                sText.innerText = "ğŸŸ  è¼”å°é€²è¡Œä¸­..."; sText.style.color = "#FF9500";
            }
        }

        function disable(...btns) {
            btns.forEach(b => { b.classList.add('btn-disabled'); b.disabled = true; });
        }

        function sendData(action) {
            let msg = "ç¢ºå®šåŸ·è¡Œï¼Ÿ";
            if(action === 'end_work') msg = "ç¢ºå®šè¦ä¸‹ç­äº†å—ï¼Ÿè¨˜å¾—å¯« Memo å–”ï¼";
            if(!confirm(msg)) return;

            const memo = document.getElementById('memo-input').value; // æŠ“å–æ–‡å­—

            document.getElementById('loading').style.display = 'block';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ 'action': action, 'memo': memo })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                if(data.result === 'success') {
                    alert(data.msg);
                    document.getElementById('memo-input').value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
                    
                    // ç‹€æ…‹åˆ‡æ›é‚è¼¯
                    if(action === 'start_work') currentState = 'working_admin';
                    else if(action === 'start_counseling') currentState = 'working_counsel';
                    else if(action === 'end_counseling') currentState = 'working_admin'; // è½‰å›è¡Œæ”¿
                    else if(action === 'end_work') currentState = 'idle';
                    
                    localStorage.setItem('workState_v4', currentState);
                    updateUI(currentState);
                } else {
                    alert(data.msg);
                }
            })
            .catch(err => {
                document.getElementById('loading').style.display = 'none';
                alert("é€£ç·šå¤±æ•—");
            });
        }

        // --- èªéŸ³è¼¸å…¥åŠŸèƒ½ (Web Speech API) ---
        function startDictation() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Safari");
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-TW'; // è¨­å®šä¸­æ–‡
            recognition.continuous = false;
            recognition.interimResults = false;

            const micBtn = document.querySelector('.btn-mic');
            micBtn.classList.add('listening');

            recognition.onstart = () => { console.log("é–‹å§‹è½å¯«..."); };
            recognition.onend = () => { micBtn.classList.remove('listening'); };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                const input = document.getElementById('memo-input');
                // æŠŠè½åˆ°çš„å­—æ¥åœ¨åŸæœ¬çš„å­—å¾Œé¢
                input.value += (input.value ? " " : "") + text;
            };

            recognition.onerror = (e) => {
                micBtn.classList.remove('listening');
                alert("èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼Œè«‹é‡è©¦");
            };

            recognition.start();
        }
    </script>
</body>
</html>
