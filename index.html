<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å¡ç³»çµ±</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        h1 { margin-bottom: 10px; color: #333; }
        .time-display { font-size: 2.5em; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .status-text { margin-bottom: 20px; font-weight: bold; color: #666; }
        
        button { width: 100%; padding: 15px; margin: 8px 0; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        
        .btn-start { background-color: #34C759; color: white; }
        .btn-counsel { background-color: #FF9500; color: white; }
        .btn-end { background-color: #FF3B30; color: white; }
        .btn-view { background-color: #007AFF; color: white; margin-top: 20px; } /* æ–°æŒ‰éˆ•ï¼šè—è‰² */
        .btn-disabled { background-color: #E5E5EA; color: #C7C7CC; cursor: not-allowed; pointer-events: none; }

        /* é¡¯ç¤ºç´€éŒ„çš„å€åŸŸ */
        #log-area { 
            display: none; /* é è¨­éš±è— */
            margin-top: 20px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 10px; 
            text-align: left; 
            font-size: 0.95em;
            border: 1px solid #eee;
        }
        .log-item { margin: 5px 0; display: flex; justify-content: space-between; }
        .log-label { color: #666; }
        .log-time { font-weight: bold; color: #333; }

        #loading { display: none; margin-top: 10px; color: #007AFF; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¼ å·¥ä½œæ‰“å¡</h1>
        <div id="current-time" class="time-display">00:00:00</div>
        <div id="status" class="status-text">ç‹€æ…‹ï¼šå°šæœªä¸Šç­</div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
        
        <button id="btn-start" class="btn-start" onclick="sendData('start_work')">ä¸Šç­ (è¡Œæ”¿é–‹å§‹)</button>
        <button id="btn-counsel" class="btn-counsel btn-disabled" onclick="sendData('start_counseling')" disabled>é–‹å§‹è¼”å°</button>
        <button id="btn-end" class="btn-end btn-disabled" onclick="sendData('end_work')" disabled>ä¸‹ç­ / çµæŸ</button>

        <button id="btn-view" class="btn-view" onclick="viewLog()">ğŸ” æŸ¥è©¢ä»Šæ—¥ç´€éŒ„</button>

        <div id="log-area">
            <div class="log-item"><span class="log-label">ä¸Šç­æ™‚é–“ï¼š</span><span id="log-start" class="log-time">--:--:--</span></div>
            <div class="log-item"><span class="log-label">è¼”å°é–‹å§‹ï¼š</span><span id="log-counsel" class="log-time">--:--:--</span></div>
            <div class="log-item"><span class="log-label">ä¸‹ç­æ™‚é–“ï¼š</span><span id="log-end" class="log-time">--:--:--</span></div>
        </div>

        <p id="loading">â³ è³‡æ–™å‚³é€ä¸­...</p>
    </div>

    <script>
        // â˜…â˜…â˜… è¨˜å¾—æ›æˆä½ çš„æ–°ç¶²å€ï¼è¨˜å¾—è¦æœ‰é›™å¼•è™Ÿï¼ â˜…â˜…â˜…
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzsGYDShuyZKKRmPBn9rCVMGBDcNvzc_LSFijKqmm3RVZhvxxUToeLpVVfKScwhpVZZzg/exec";

        setInterval(() => {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleTimeString('en-GB', {hour12: false});
        }, 1000);

        let currentState = localStorage.getItem('workState') || 'idle'; 
        updateUI(currentState);

        function updateUI(state) {
            const btnStart = document.getElementById('btn-start');
            const btnCounsel = document.getElementById('btn-counsel');
            const btnEnd = document.getElementById('btn-end');
            const statusText = document.getElementById('status');

            btnStart.className = 'btn-start'; btnCounsel.className = 'btn-counsel'; btnEnd.className = 'btn-end';
            btnStart.disabled = false; btnCounsel.disabled = false; btnEnd.disabled = false;

            if (state === 'idle') {
                btnCounsel.classList.add('btn-disabled'); btnCounsel.disabled = true;
                btnEnd.classList.add('btn-disabled'); btnEnd.disabled = true;
                statusText.innerText = "ç‹€æ…‹ï¼šå°šæœªä¸Šç­"; statusText.style.color = "#666";
            } else if (state === 'working_admin') {
                btnStart.classList.add('btn-disabled'); btnStart.disabled = true;
                statusText.innerText = "ğŸŸ¢ ç‹€æ…‹ï¼šè¡Œæ”¿å·¥ä½œä¸­"; statusText.style.color = "#34C759";
            } else if (state === 'working_counsel') {
                btnStart.classList.add('btn-disabled'); btnStart.disabled = true;
                btnCounsel.classList.add('btn-disabled'); btnCounsel.disabled = true;
                statusText.innerText = "ğŸŸ  ç‹€æ…‹ï¼šè¼”å°é€²è¡Œä¸­"; statusText.style.color = "#FF9500";
            }
        }

        // --- æ–°å¢ï¼šæŸ¥è©¢åŠŸèƒ½ ---
        function viewLog() {
            // 1. è¨ˆç®—ä»Šå¤©çš„å‹•æ…‹å¯†ç¢¼ (MMdd)
            const now = new Date();
            // padStart(2, '0') æ„æ€æ˜¯å¦‚æœæ•¸å­—åªæœ‰ä¸€ä½ï¼Œå‰é¢è£œ 0 (ä¾‹å¦‚ 1æœˆ è®Šæˆ 01)
            const month = (now.getMonth() + 1).toString().padStart(2, '0'); 
            const date = now.getDate().toString().padStart(2, '0');
            const correctPassword = month + date; // çµ„åˆå¯†ç¢¼ï¼Œä¾‹å¦‚ 1119

            // 2. è·³å‡ºè¼¸å…¥æ¡†
            const userPassword = prompt("ğŸ”’ å®‰å…¨é©—è­‰\nè«‹è¼¸å…¥ä»Šæ—¥å¯†ç¢¼ï¼š");

            // 3. é©—è­‰å¯†ç¢¼
            if (userPassword === correctPassword) {
                // å¯†ç¢¼å°äº†ï¼Œå»å¾Œç«¯æŠ“è³‡æ–™
                fetchData();
            } else {
                if(userPassword !== null) alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼"); // å¦‚æœæŒ‰å–æ¶ˆå°±ä¸è·³éŒ¯èª¤
            }
        }

        function fetchData() {
            document.getElementById('loading').innerText = "ğŸ” æŸ¥è©¢è³‡æ–™ä¸­...";
            document.getElementById('loading').style.display = 'block';
            document.getElementById('log-area').style.display = 'none'; // å…ˆè—èµ·ä¾†

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ 'action': 'get_today_log' })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                if(data.result === 'success') {
                    // æŠŠæŠ“åˆ°çš„æ™‚é–“å¡«å…¥æ ¼å­
                    document.getElementById('log-start').innerText = data.data.start;
                    document.getElementById('log-counsel').innerText = data.data.counsel;
                    document.getElementById('log-end').innerText = data.data.end;
                    // é¡¯ç¤ºå€åŸŸ
                    document.getElementById('log-area').style.display = 'block';
                } else {
                    alert(data.msg);
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                alert("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«");
            });
        }

        // --- åŸæœ¬çš„æ‰“å¡åŠŸèƒ½ ---
        function sendData(action) {
            let msg = "";
            if(action === 'start_work') msg = "ç¢ºå®šè¦æ‰“å¡ä¸Šç­å—ï¼Ÿ";
            if(action === 'start_counseling') msg = "ç¢ºå®šè¦é–‹å§‹è¨˜éŒ„è¼”å°æ™‚é–“å—ï¼Ÿ";
            if(action === 'end_work') msg = "ç¢ºå®šè¦ä¸‹ç­äº†å—ï¼Ÿ";
            if(!confirm(msg)) return;

            document.getElementById('loading').innerText = "â³ è³‡æ–™å‚³é€ä¸­...";
            document.getElementById('loading').style.display = 'block';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ 'action': action })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                if(data.result === 'success') {
                    alert(data.msg);
                    if(action === 'start_work') currentState = 'working_admin';
                    else if (action === 'start_counseling') currentState = 'working_counsel';
                    else if (action === 'end_work') currentState = 'idle';
                    localStorage.setItem('workState', currentState);
                    updateUI(currentState);
                } else {
                    alert(data.msg);
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            });
        }
    </script>
</body>
</html>
